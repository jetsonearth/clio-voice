python3 - << 'PY'
import os, difflib, re, csv
clio_root = '/Users/ZhaobangJetWu/clio-project/Clio/Clio'
vi_root = '/Users/ZhaobangJetWu/VoiceInk/VoiceInk'
out_csv = '/Users/ZhaobangJetWu/clio-project/Clio/strategy/research/gpl_similarity_report.csv'
os.makedirs(os.path.dirname(out_csv), exist_ok=True)

# Collect swift files by basename
clio_files = {}
for dp,_,files in os.walk(clio_root):
    for f in files:
        if f.endswith('.swift'):
            clio_files.setdefault(f, []).append(os.path.join(dp,f))

vi_files = {}
for dp,_,files in os.walk(vi_root):
    for f in files:
        if f.endswith('.swift'):
            vi_files.setdefault(f, []).append(os.path.join(dp,f))

rows = []
for basename in sorted(set(clio_files).intersection(vi_files)):
    for a in clio_files[basename]:
        for b in vi_files[basename]:
            try:
                with open(a,'r',errors='ignore') as fa, open(b,'r',errors='ignore') as fb:
                    ta, tb = fa.read(), fb.read()
                def norm(s):
                    s = re.sub(r'//.*', '', s)
                    s = re.sub(r'/\*[\s\S]*?\*/', '', s)
                    s = re.sub(r'\s+', ' ', s)
                    return s.strip()
                na, nb = norm(ta), norm(tb)
                ratio = difflib.SequenceMatcher(None, na, nb).ratio()
                if ratio >= 0.60:
                    rows.append([ratio, a, b])
            except Exception:
                pass

rows.sort(reverse=True, key=lambda r: r[0])
with open(out_csv,'w',newline='') as f:
    w = csv.writer(f)
    w.writerow(['similarity','clio_file','voiceink_file'])
    for r in rows:
        w.writerow([f"{r[0]:.4f}", r[1], r[2]])
print(f"Wrote {len(rows)} rows to {out_csv}")
PY


python3 - << 'PY'
import os, re, csv
root = '/Users/ZhaobangJetWu/clio-project/Clio/Clio'
out_csv = '/Users/ZhaobangJetWu/clio-project/Clio/strategy/research/unused_candidates.csv'
os.makedirs(os.path.dirname(out_csv), exist_ok=True)

# Collect all Swift files and type names (class/struct/enum)
files = []
for dp,_,fs in os.walk(root):
    for f in fs:
        if f.endswith('.swift'):
            files.append(os.path.join(dp,f))

pattern = re.compile(r'\b(class|struct|enum)\s+(\w+)')
name_to_file = {}
for p in files:
    try:
        s = open(p,'r',errors='ignore').read()
    except: s=''
    for m in pattern.finditer(s):
        name_to_file[m.group(2)] = p

# Build a big text for reference scanning
all_text = ''
for p in files:
    try:
        all_text += open(p,'r',errors='ignore').read() + '\n'
    except: pass

unused = []
for name, path in name_to_file.items():
    # Count references excluding the declaration site by searching name occurrences
    count = len(re.findall(r'\b'+re.escape(name)+r'\b', all_text))
    # Heuristic: if count == 1, only declared, not referenced elsewhere
    if count <= 1:
        unused.append((name, path))

with open(out_csv,'w',newline='') as f:
    w = csv.writer(f)
    w.writerow(['type_name','file_path'])
    for name,path in sorted(unused):
        w.writerow([name, path])
print(f"Wrote {len(unused)} candidates to {out_csv}")
PY